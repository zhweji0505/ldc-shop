# LDC Store - Linux DO ç§¯åˆ†å•†åŸ (Workers v2)

> ğŸ“ **è¯·å…ˆè¿›å…¥æ­¤ç›®å½•å†æ‰§è¡Œåç»­å‘½ä»¤ï¼š**
> ```bash
> cd _workers_v2
> ```

åŸºäº **Cloudflare Workers** + **D1 Database** æ„å»ºçš„ Serverless è™šæ‹Ÿå•†å“è‡ªåŠ¨å‘è´§ç³»ç»Ÿã€‚ä¸“ä¸º Linux DO ç”Ÿæ€è®¾è®¡ï¼Œæ”¯æŒ **Linux DO Credit** ç§¯åˆ†æ”¯ä»˜å’Œ **Linux DO Connect** (OIDC) ç™»å½•ã€‚

> æœ¬ Workers ç‰ˆæœ¬ä»…æ”¯æŒ **Wrangler å‘½ä»¤éƒ¨ç½²**ï¼Œä¸æä¾›ä¸€é”®éƒ¨ç½²æŒ‰é’®ã€‚

## âœ¨ ç‰¹æ€§

- **Serverless æ¶æ„**ï¼šå®Œå…¨è¿è¡Œåœ¨ Cloudflare è¾¹ç¼˜ç½‘ç»œï¼Œä½æˆæœ¬ã€é«˜æ€§èƒ½ã€‚
- **è‡ªåŠ¨å‘è´§**ï¼šæ”¯ä»˜æˆåŠŸåè‡ªåŠ¨å±•ç¤ºå¡å¯†/CDKï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚
- **åº“å­˜é”å®šä¸è¶…æ—¶é‡Šæ”¾**ï¼šè¿›å…¥æ”¯ä»˜é¡µé”å®š 1 åˆ†é’Ÿï¼Œ5 åˆ†é’Ÿæœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆå¹¶é‡Šæ”¾åº“å­˜ã€‚
- **é™è´­**ï¼šæŒ‰å·²æ”¯ä»˜æ¬¡æ•°é™åˆ¶è´­ä¹°ã€‚
- **å•†åŸä½“éªŒ**ï¼šæœç´¢/åˆ†ç±»ç­›é€‰ã€å…¬å‘Šæ ã€Markdown å•†å“æè¿°ã€è¯„åˆ†ä¸è¯„è®ºã€è®¿å®¢æ•°é‡ç»Ÿè®¡ã€‚
- **ç¤¾äº¤åˆ†äº«**ï¼šæ”¯æŒ X/Twitterã€Facebookã€Telegramã€WhatsAppã€Line å’Œå¤åˆ¶é“¾æ¥ã€‚
- **Linux DO æ·±åº¦é›†æˆ**ï¼š
    - æ”¯æŒ **Linux DO Connect** (OIDC) ä¸€é”®ç™»å½•ã€‚
    - æ”¯æŒ **Linux DO Credit** (EasyPay åè®®) ç§¯åˆ†æ”¯ä»˜ã€‚
- **ç®¡ç†åå°**ï¼šå•†å“ä¸Šä¸‹æ¶/æ’åº/é™è´­ã€åº“å­˜ç®¡ç†ã€è®¢å•æŸ¥è¯¢ã€é€€æ¬¾ã€å…¬å‘Šé…ç½®ã€‚
- **å®‰å…¨å¯é **ï¼šæ— æœåŠ¡å™¨ç»´æŠ¤çƒ¦æ¼ï¼Œæ•°æ®é€šè¿‡ Cloudflare D1 ä¿éšœã€‚

> å®šæ—¶æ¸…ç†ç”± `wrangler.toml` çš„ `crons` é…ç½®è§¦å‘ï¼ˆé»˜è®¤æ¯åˆ†é’Ÿä¸€æ¬¡ï¼‰ï¼Œå¯æŒ‰éœ€è°ƒæ•´ã€‚

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒå‡†å¤‡
ç¡®ä¿ä½ å·²ç»å®‰è£…äº† Node.js å’Œ Wrangler (Cloudflare CLI)ã€‚
```bash
npm install -g wrangler
wrangler login
```

### 2. åˆå§‹åŒ–æ•°æ®åº“ (Cloudflare D1)
é¦–å…ˆåœ¨ Cloudflare åˆ›å»ºä¸€ä¸ª D1 æ•°æ®åº“ï¼Œå»ºè®®å‘½åä¸º `ldc-shop-db`ã€‚
å¦‚æœä½ è¿˜æ²¡æœ‰åˆ›å»ºï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ï¼š
```bash
wrangler d1 create ldc-shop-db
```
å¤åˆ¶æ§åˆ¶å°è¾“å‡ºçš„ `database_id`ï¼Œæ›¿æ¢å½“å‰ç›®å½• `_workers_v2/wrangler.toml` æ–‡ä»¶ä¸­çš„ `database_id` å­—æ®µã€‚

ç„¶ååˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„ï¼š
```bash
wrangler d1 execute ldc-shop-db --file=schema.sql
```

> å¦‚æœä»æ—§ç‰ˆå‡çº§ï¼šå»ºè®®æ–°å»º D1 æ•°æ®åº“ï¼Œæˆ–æ‰‹åŠ¨æ–°å¢å­—æ®µä¸è¡¨ï¼ˆproducts.is_active/sort_order/purchase_limitã€cards.reserved_order_id/reserved_atã€sessions.csrf_tokenã€settingsã€reviewsã€login_usersï¼‰ã€‚

### 3. è·å–åº”ç”¨å‡­è¯ (å…³é”®æ­¥éª¤)

ä½ éœ€è¦åˆ†åˆ«ç”³è¯· **æ”¯ä»˜æ¥å£** å’Œ **ç™»å½•æ¥å£** çš„å‡­è¯ã€‚å‡è®¾ä½ çš„éƒ¨ç½²åŸŸåæ˜¯ `https://ldc.chatgpt.org.uk`ï¼ˆ**è¯·åŠ¡å¿…æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å®é™…åŸŸå**ï¼‰ã€‚

#### A. æ”¯ä»˜æ¥å£å‡­è¯ (Merchant)
å‰å¾€ [Linux DO Credit Merchant](https://credit.linux.do/merchant) åˆ›å»ºåº”ç”¨ï¼Œè·å– **Client ID** å’Œ **Client Secret**ã€‚

é…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š

| å­—æ®µ | ç¤ºä¾‹å¡«å†™ (è¯·æ›¿æ¢ä½ çš„åŸŸå) | è¯´æ˜ |
| :--- | :--- | :--- |
| **åº”ç”¨åœ°å€** | `https://ldc.chatgpt.org.uk` | å•†åŸé¦–é¡µåœ°å€ |
| **å›è°ƒ URI** | `https://ldc.chatgpt.org.uk/callback` | ç”¨æˆ·æ”¯ä»˜åçš„å‰ç«¯è·³è½¬åœ°å€ |
| **é€šçŸ¥ URL** | `https://ldc.chatgpt.org.uk/notify` | æ”¯ä»˜æˆåŠŸçš„å¼‚æ­¥é€šçŸ¥åœ°å€ (Server-to-Server) |

- è·å–åˆ°çš„ `Client ID` å¯¹åº”åé…ç½®çš„ `MERCHANT_ID`
- è·å–åˆ°çš„ `Client Secret` å¯¹åº”åç»­é…ç½®çš„ `MERCHANT_KEY`

#### B. ç™»å½•æ¥å£å‡­è¯ (OAuth)
å‰å¾€ [Linux DO Connect](https://connect.linux.do/dash/sso) ç”³è¯·æ–°æ¥å…¥ï¼Œè·å– **Client ID** å’Œ **Client Secret**ã€‚

é…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š

| å­—æ®µ | ç¤ºä¾‹å¡«å†™ (è¯·æ›¿æ¢ä½ çš„åŸŸå) | è¯´æ˜ |
| :--- | :--- | :--- |
| **åº”ç”¨ä¸»é¡µ** | `https://ldc.chatgpt.org.uk` | å•†åŸé¦–é¡µåœ°å€ |
| **åº”ç”¨æè¿°** | `LDC STORE` | åº”ç”¨åç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨æˆæƒé¡µ |
| **å›è°ƒåœ°å€** | `https://ldc.chatgpt.org.uk/authcallback` | OAuth æˆæƒå›è°ƒåœ°å€ |

- è·å–åˆ°çš„ `Client ID` å¯¹åº”åç»­é…ç½®çš„ `OAUTH_CLIENT_ID`
- è·å–åˆ°çš„ `Client Secret` å¯¹åº”åç»­é…ç½®çš„ `OAUTH_CLIENT_SECRET`

### 4. é…ç½®ç¯å¢ƒå˜é‡ (Secrets)
ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæ‰€æœ‰æ•æ„Ÿä¿¡æ¯éƒ½åº”é€šè¿‡ Cloudflare Secrets å­˜å‚¨ï¼Œä»£ç ä¸­ä¸åŒ…å«ä»»ä½•å¯†é’¥ã€‚

åœ¨ `_workers_v2` ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆä¾æ¬¡è¾“å…¥ä¸Šä¸€æ­¥è·å–çš„å€¼ï¼‰ï¼š

```bash
# === æ”¯ä»˜é…ç½® ===
# è¾“å…¥ä½ åœ¨ credit.linux.do è·å–çš„ Client ID
wrangler secret put MERCHANT_ID

# è¾“å…¥ä½ åœ¨ credit.linux.do è·å–çš„ Client Secret
wrangler secret put MERCHANT_KEY

# === ç™»å½•é…ç½® ===
# è¾“å…¥ä½ åœ¨ connect.linux.do è·å–çš„ Client ID
wrangler secret put OAUTH_CLIENT_ID

# è¾“å…¥ä½ åœ¨ connect.linux.do è·å–çš„ Client Secret
wrangler secret put OAUTH_CLIENT_SECRET

# === ç®¡ç†å‘˜é…ç½® ===
# è¾“å…¥ç®¡ç†å‘˜çš„ Linux DO ç”¨æˆ·åï¼ˆå¤šä¸ªç”¨æˆ·ç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼Œå¦‚: user1,user2ï¼‰
wrangler secret put ADMIN_USERS
```

### 5. éƒ¨ç½²ä¸Šçº¿
```bash
wrangler deploy
```
éƒ¨ç½²æˆåŠŸåï¼Œè®¿é—®ä½ çš„åŸŸåå³å¯å¼€å§‹ä½¿ç”¨ï¼

## ğŸ› ï¸ ç®¡ç†å‘˜åŠŸèƒ½
1. éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®ç½‘ç«™ã€‚
2. ç‚¹å‡»å³ä¸Šè§’ "Login" ä½¿ç”¨ Linux DO è´¦å·ç™»å½•ã€‚
3. å¦‚æœä½ çš„ç”¨æˆ·ååœ¨ `ADMIN_USERS` åˆ—è¡¨ä¸­ï¼Œç™»å½•åå¯¼èˆªæ ä¼šå‡ºç° "Admin" èœå•ã€‚
4. åœ¨åå°ä½ å¯ä»¥ï¼š
    - **Products**: åˆ›å»ºå•†å“ã€è®¾ç½®ä¸Šä¸‹æ¶ã€æ’åºã€é™è´­ã€å›¾ç‰‡å¤–é“¾ã€‚
    - **Cards**: ä¸ºå¯¹åº”å•†å“å¯¼å…¥å¡å¯†/CDKåº“å­˜ï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰ã€‚
    - **Orders**: æŸ¥çœ‹æ‰€æœ‰è®¢å•æµæ°´ï¼Œæ”¯æŒä¸€é”®å¤åˆ¶å¡å¯†å’Œé€€æ¬¾æ“ä½œã€‚
    - **Announcement**: é…ç½®é¦–é¡µå…¬å‘Šã€‚

## ğŸ“„ å¼€æºåè®®
MIT
